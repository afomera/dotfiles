{{- if eq .chezmoi.os "darwin" -}}
#!/usr/bin/env sh

# apps.yml hash: {{ include ".chezmoidata/apps.yml" | sha256sum }}

get_version() {
  local app_path="$1"
  if [ -d "$app_path" ]; then
    defaults read "${app_path}/Contents/Info" CFBundleShortVersionString 2>/dev/null || echo "0"
  else
    echo "0"
  fi
}

install_dmg() {
  local name="$1"
  local url="$2"
  local app_name="$3"
  local dmg_path="/tmp/${name}.dmg"

  echo "==> Checking ${name}..."

  if ! curl -L -s -f -o "$dmg_path" "$url"; then
    echo "    Failed to download ${name}, skipping"
    return
  fi

  local mount_output
  mount_output=$(hdiutil attach "$dmg_path" -nobrowse 2>&1)
  local mount_point
  mount_point=$(echo "$mount_output" | grep '/Volumes/' | sed 's/.*\/Volumes/\/Volumes/' | head -1)

  if [ -z "$mount_point" ]; then
    echo "    Failed to mount ${name}.dmg, skipping"
    rm -f "$dmg_path"
    return
  fi

  if [ ! -d "${mount_point}/${app_name}" ]; then
    echo "    Warning: ${app_name} not found in ${mount_point}"
    echo "    Contents: $(ls "${mount_point}" 2>&1)"
    hdiutil detach "${mount_point}" -quiet 2>/dev/null
    rm -f "$dmg_path"
    return
  fi

  local installed_version
  local dmg_version
  installed_version=$(get_version "/Applications/${app_name}")
  dmg_version=$(get_version "${mount_point}/${app_name}")

  if [ "$installed_version" = "$dmg_version" ] && [ "$installed_version" != "0" ]; then
    echo "    ${name} v${installed_version} is up to date"
  else
    rm -rf "/Applications/${app_name}"
    cp -R "${mount_point}/${app_name}" /Applications/
    echo "    ${name} installed: v${dmg_version} (was v${installed_version})"
  fi

  hdiutil detach "${mount_point}" -quiet 2>/dev/null
  rm -f "$dmg_path"
}

{{ range .dmg_apps -}}
install_dmg "{{ .name }}" "{{ .url }}" "{{ .app_name }}"
{{ end -}}
{{ end -}}
