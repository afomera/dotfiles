#!/bin/bash
set -e

apply_dotfiles() {
  echo "==> Applying dotfiles"
  chezmoi init afomera --apply
  (cd "$HOME/.local/share/chezmoi" && git remote remove origin 2>/dev/null || true && git remote add origin git@github.com:afomera/dotfiles.git)
}

install_1password() {
  if [ -d "/Applications/1Password.app" ] || [ -d "$HOME/Applications/1Password.app" ] || brew list --cask 1password >/dev/null 2>&1; then
    echo "==> 1Password already installed, skipping"
  else
    echo "==> Installing 1Password"
    brew install --cask 1password
  fi

  if ! command -v op >/dev/null 2>&1; then
    echo "==> Installing 1Password CLI"
    brew install --cask 1password-cli
    prompt_1password_configuration
  fi
}

prompt_1password_configuration() {
  echo ""
  echo "==> Please complete the following steps:"
  echo "  1. Open 1Password"
  echo "  2. Sign in to 1Password CLI if prompted"
  echo "  3. Go to Settings > Developer"
  echo "  4. Enable 'Connect with 1Password CLI'"
  echo ""
  printf "Press Enter once you have completed these steps..."
  read -r
}

install_chezmoi() {
  if ! command -v chezmoi >/dev/null 2>&1; then
    echo "==> Installing chezmoi"
    brew install chezmoi
  fi
}

install_packages() {
  echo "==> Updating Homebrew"
  brew update
  echo "==> Installing Homebrew packages from Brewfile"
  brew bundle --file="$HOME/.config/homebrew/Brewfile" || echo "Warning: some Brewfile dependencies failed to install"
  brew cleanup || true
}

install_xcode_cli() {
  if ! xcode-select -p >/dev/null 2>&1; then
    echo "==> Installing Xcode CLI tools"
    xcode-select --install
    printf "Press Enter after Xcode CLI tools installation completes..."
    read -r
  fi
}

install_homebrew() {
  if ! command -v brew >/dev/null 2>&1; then
    echo "==> Installing Homebrew"
    NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
  fi
}

case "$(uname -s)" in
Darwin)
  install_xcode_cli
  install_homebrew
  install_1password
  install_chezmoi
  apply_dotfiles
  install_packages

  echo "Setup Complete"
  echo "Open a new terminal to use your new shell config."
  zsh
  ;;
*)
  echo "Unsupported operating system: $(uname -s)"
  exit 1
  ;;
esac
